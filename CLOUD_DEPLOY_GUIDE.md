# 🌥️ 云开发部署指南

## 📋 环境信息

- **云开发环境ID**: `cloud1-5gk8vs2q7ed3e658`
- **云函数名称**: `lottery-api`
- **数据存储**: 云函数文件存储（暂用）

## 🚀 部署步骤

### 1️⃣ 安装云函数依赖

在微信开发者工具中：

1. **打开云函数目录**
   ```
   右键点击 cloudfunctions/lottery-api 目录
   → 选择"在终端中打开"
   ```

2. **安装依赖**
   ```bash
   cd cloudfunctions/lottery-api
   npm install
   ```

3. **或者在微信开发者工具中**
   ```
   右键点击 cloudfunctions/lottery-api 目录
   → 选择"在终端中打开" → "安装依赖"
   ```

### 2️⃣ 上传并部署云函数

1. **上传云函数**
   ```
   右键点击 cloudfunctions/lottery-api 目录
   → 选择"上传并部署：云端安装依赖"
   ```

2. **等待部署完成**
   - 控制台显示部署进度
   - 成功后会显示绿色勾号

### 3️⃣ 配置云开发环境

1. **开通云开发**
   ```
   微信开发者工具 → 云开发 → 开通
   ```

2. **选择环境**
   - 环境ID: `cloud1-5gk8vs2q7ed3e658`
   - 环境名称: 自定义（如：lottery-prod）

### 4️⃣ 测试云函数

在微信开发者工具中：

1. **打开云函数测试**
   ```
   云开发 → 云函数 → lottery-api → 测试
   ```

2. **测试健康检查**
   ```json
   {
     "action": "health"
   }
   ```
   
   **预期返回：**
   ```json
   {
     "success": true,
     "message": "云函数运行正常",
     "timestamp": "2025-11-12T17:20:00.000Z"
   }
   ```

3. **测试数据状态**
   ```json
   {
     "action": "data_status"
   }
   ```

## 📁 文件结构

```
miniprogram/
├── cloudfunctions/
│   └── lottery-api/
│       ├── index.js          # 云函数主文件
│       ├── package.json      # 依赖配置
│       ├── lottery_data.json # 数据文件
│       └── node_modules/     # 依赖包
├── app.js                   # 小程序入口（已配置云开发）
├── app.json                 # 小程序配置（已启用云开发）
└── utils/api.js             # API工具类（已更新为云函数调用）
```

## 🔧 配置说明

### 小程序配置

**app.json**
```json
{
  "cloud": true,
  "usingComponents": { ... }
}
```

**app.js**
```javascript
wx.cloud.init({
  env: 'cloud1-5gk8vs2q7ed3e658',
  traceUser: true,
})
```

### 云函数支持的操作

| 操作 | 参数 | 说明 |
|------|------|------|
| health | - | 健康检查 |
| data_status | - | 获取数据状态 |
| update_data | - | 更新数据（模拟） |
| get_predictions | strategy | 获取预测号码 |
| get_history | offset, limit | 获取历史数据 |

### 策略参数

| strategy | 说明 |
|----------|------|
| all | 全部数据 |
| recent_3_years | 最近3年 |
| this_year | 今年 |
| this_month | 本月 |

## 🧪 功能测试

### 1. 编译小程序
```
微信开发者工具 → 编译
```

### 2. 测试各个功能

1. **首页数据状态**
   - 打开小程序首页
   - 应该显示数据统计信息

2. **获取预测号码**
   - 选择不同策略
   - 点击生成推荐
   - 查看预测结果

3. **历史数据**
   - 切换到历史数据页
   - 查看分页加载

## 🐛 常见问题

### 1. 云函数调用失败

**症状**: `云函数调用失败`

**解决**:
- 检查云函数是否正确上传
- 确认环境ID配置正确
- 查看云开发控制台错误日志

### 2. 数据文件未找到

**症状**: `暂无历史数据`

**解决**:
- 确认 `lottery_data.json` 已复制到云函数目录
- 重新上传云函数
- 检查文件格式是否正确

### 3. 网络权限问题

**症状**: `没有云开发权限`

**解决**:
- 确认已开通云开发服务
- 检查小程序AppID是否有云开发权限
- 联系小程序管理员开通权限

## 📊 数据迁移（可选）

### 当前方案：文件存储
- 数据保存在云函数文件中
- 简单直接，适合小数据量

### 升级方案：云数据库
- 使用云数据库集合存储
- 支持更复杂的查询
- 更好的性能和扩展性

如果需要升级到云数据库，请告知，我可以提供迁移方案。

## 🎯 部署完成检查

- [ ] 云函数依赖安装完成
- [ ] 云函数上传成功
- [ ] 云开发环境配置正确
- [ ] 小程序编译无错误
- [ ] 首页数据正常显示
- [ ] 预测功能正常工作
- [ ] 历史数据正常加载

---

**部署完成后，小程序将使用云开发，不再需要本地API服务器！** 🚀